from telethon import TelegramClient, events
import cohere
from dotenv import dotenv_values
import json
import time
from fuzzywuzzy import fuzz

env_values = dotenv_values(".env")

api_id = int(env_values.get("API_ID"))
api_hash = env_values.get("API_HASH")
cohere_api_key = env_values.get("COHERE_API_KEY")

apartments_file = env_values.get("APARTMENTS_FILE", "apartments.json")


try:
    with open(apartments_file, "r", encoding="utf-8") as f:
        apartments = json.load(f)
except Exception as e:
    print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –∫–≤–∞—Ä—Ç–∏—Ä: {e}")
    apartments = []

apartments_str = "\n".join(
    [
        f" {apt['name']}\n {apt['address']}\n {apt['price']}\n  {apt['info']}\n "
        for apt in apartments
    ]
)

# –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç Cohere
co = cohere.ClientV2(api_key=cohere_api_key)

# –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç Telegram
client = TelegramClient("session_name", api_id, api_hash)

# –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
dialogues = {}


async def send_apartment_photo(user_id, apartment_id):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ."""
    for apartment in apartments:
        if apartment["id"] == apartment_id:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
            await client.send_file(user_id, apartment["photo"])


def generate_response(user_id, user_message):
    try:
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
        if user_id not in dialogues:
            dialogues[user_id] = []

        dialogues[user_id].append({"role": "user", "content": user_message})

        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 20 –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å API)
        dialogues[user_id] = dialogues[user_id][-20:]

        # –ó–∞–ø—Ä–æ—Å –∫ Cohere —Å –∏—Å—Ç–æ—Ä–∏–µ–π
        response = co.chat(
            model="command-r7b-12-2024",
            messages=dialogues[user_id],  # –ü–µ—Ä–µ–¥–∞–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é
            max_tokens=200,  # –î–∞–µ–º –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞
        )

        print("–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç Cohere:", response)  # üëÄ –í—ã–≤–æ–¥–∏–º –æ—Ç–≤–µ—Ç API

        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç
        if response.message and response.message.content:
            bot_reply = response.message.content[0].text.strip()
            # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
            dialogues[user_id].append({"role": "assistant", "content": bot_reply})

            return bot_reply
        else:
            return "–û—à–∏–±–∫–∞: API –Ω–µ –≤–µ—Ä–Ω—É–ª —Ç–µ–∫—Å—Ç."
    except Exception as e:
        return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞: {str(e)}"


@client.on(events.NewMessage(incoming=True))
async def handle_new_message(event):
    user_message = event.message.message
    sender = await event.get_sender()
    user_id = sender.id  # –ü–æ–ª—É—á–∞–µ–º ID –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è

    if not event.is_private:  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤—Å–µ, –∫—Ä–æ–º–µ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        return

    print(f"–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {sender.username}: {user_message}")

    # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–æ–≥–µ, –¥–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
    if user_id not in dialogues:
        prompt = (
            "—è –∏—Å–ø–æ–ª—å–∑—É—é —Ç–µ–±—è –≤–º–µ—Å—Ç–µ —Å —Å–∫—Ä–∏–ø—Ç–æ–º –∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–∏–≥–µ—Ä–∏—Ç –Ω–∞ —Ä–∞–∑–Ω—ã–µ –ø—Ä–æ–ø–∏—Å–∞–Ω–Ω—ã–µ –Ω–∏–∂–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞—Ä–∞–Ω–µ–µ –ø—Ä–æ–ø–∏—Å–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏—Å—Ö–æ–¥—è –∏–∑ —Ç–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤. –ü–æ—ç—Ç–æ–º—É —á–µ—Ç–∫–æ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Å—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π, —á—Ç–æ –±—ã —Å–∫—Ä–∏–ø—Ç –º–æ–≥ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∑–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
            "## –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Ä–æ–ª–∏ —Ä–∏–µ–ª—Ç–æ—Ä–∞\n"
            f"–¢—ã ‚Äî –∂–µ–Ω—â–∏–Ω–∞ —Ä–∏–µ–ª—Ç–æ—Ä, —É —Ç–µ–±—è –µ—Å—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—ã –Ω–∞ —Å–¥–∞—á—É. –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–≤–∞—Ä—Ç–∏—Ä: {apartments_str}. –∏—Å–ø–æ–ª—å–∑—É–π —É–∫–∞–∑–∞–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä –Ω–µ –∏–∑–º–µ–Ω—è—è –∏—Ö –≤–æ –≤—Å–µ –¥–∏–∞–ª–æ–≥–µ "
            "–ö —Ç–µ–±–µ –ø–∏—à–µ—Ç –∫–ª–∏–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —É–≤–∏–¥–µ–ª –æ–¥–Ω–æ –∏–∑ —Ç–≤–æ–∏—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ –∫–≤–∞—Ä—Ç–∏—Ä–µ. –î–ª—è –Ω–∞—á–∞–ª–∞ —É—Ç–æ—á–Ω–∏ –æ –∫–∞–∫–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ –∫–ª–∏–µ–Ω—Ç –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è\n\n"
            "## –°—Ç–∏–ª—å –∏ —Ñ–æ—Ä–º–∞—Ç –æ–±—â–µ–Ω–∏—è\n"
            "üîπ –û–±—â–∞–π—Å—è –≤–µ–∂–ª–∏–≤–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –Ω–æ –ø–æ –¥–µ–ª—É.\n"
            "üîπ –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç—ã–µ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã, –∏–∑–±–µ–≥–∞—è –∏–∑–ª–∏—à–Ω–µ–π —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–∏.\n"
            "üîπ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å –ø–æ–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '—Ä–∞–¥(–∞)').\n"
            "üîπ –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã.\n"
            "üîπ –û–±—Ä–∞—â–∞–π—Å—è –∫ –∫–ª–∏–µ–Ω—Ç—É –Ω–∞ '–≤—ã'.\n\n"
            "## –ó–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã\n"
            "### 1. –£—Ç–æ—á–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–≤–∞—Ä—Ç–∏—Ä–µ\n"
            "üìå –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ —É–∫–∞–∑–∞–ª, –æ –∫–∞–∫–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ –∏–¥–µ—Ç —Ä–µ—á—å, —Å–ø—Ä–æ—Å–∏:\n"
            "üëâ '–£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ –∫–∞–∫–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ –∏–¥–µ—Ç —Ä–µ—á—å?'\n\n"
            "### 2. –û—Ç–≤–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\n"
            "—Ñ–æ—Ä–º–∞—Ç 1 :{üè† *{apartment_name}*\nüìç *–ê–¥—Ä–µ—Å:* {address}\n üí∞ *–¶–µ–Ω–∞:* {price}\n üü£*–ò–Ω—Ñ–æ:* {info}\n\n }"
            "—Ñ–æ—Ä–º–∞—Ç 2 :{üè† *{apartment_name}*\nüìç *–ê–¥—Ä–µ—Å:* {address}\n üí∞ *–¶–µ–Ω–∞:* {price}\n\n }"
            "üìå –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ –∏–ª–∏ —Ñ–æ—Ç–æ, –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç 1 –Ω–µ –∑–∞–¥–∞–≤–∞—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:\n"
            "üìå –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∫–≤–∞—Ä—Ç–∏—Ä, –æ—Ç–ø—Ä–∞–≤—å –∏—Ö –≤ —ç—Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ 2 –Ω–µ –∑–∞–¥–∞–≤–∞—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤\n"
            "üìå –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç —Ñ–æ—Ç–æ, –æ—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ä–º–∞—Ç 1 –ø–æ —ç—Ç–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ '\n\n"
            "- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç '–ö–∞–∫–∏–µ –µ—Å—Ç—å?', –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–≤–∞—Ä—Ç–∏—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ 2, –∏—Å–ø–æ–ª—å–∑—É—è —Å–º–∞–π–ª–∏–∫ –¥–æ–º (üè†) –ø–µ—Ä–µ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç 1 —Ç–æ–ª—å–∫–æ –≤ —Ç–æ–º —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ –∏–ª–∏ —Ñ–æ—Ç–æ."
            "### 3. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç\n"
            "üìå –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã, –æ—Ç–≤–µ—á–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ:\n"
            "üëâ '–Ø —É—Ç–æ—á–Ω—é —É —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞ –∏ —Å–∫–æ—Ä–æ –≤–∞–º –æ—Ç–ø–∏—à—É—Å—å!'\n"
            "üëâ '–°–µ–π—á–∞—Å —Ç–∞–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç, –Ω–æ –º–æ–≥—É —É–∑–Ω–∞—Ç—å. –í–∞–º —á—Ç–æ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤–∞–∂–Ω–æ?'\n\n"
            "### 4. –ó–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä\n"
            "üìå –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω, –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è:\n"
            "üëâ '–ú–æ–∂–Ω–æ –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è –æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ. –ö–æ–≥–¥–∞ –≤–∞–º —É–¥–æ–±–Ω–æ?'\n\n"
            "### 5. –ü–µ—Ä–µ–≤–æ–¥ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –≤ –Ω—É–∂–Ω–æ–µ —Ä—É—Å–ª–æ\n"
            "üìå –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç —á—Ç–æ-—Ç–æ –Ω–µ—Å–≤—è–∑–Ω–æ–µ –∏–ª–∏ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ:\n"
            "üëâ '–Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å –≤–∞–º —Å –ø–æ–∏—Å–∫–æ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã! –ö–∞–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤–∞–º –Ω—É–∂–Ω–∞?'\n"
            "üëâ '–ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª –≤–∞—Å. –í—ã –∏—â–µ—Ç–µ –∫–≤–∞—Ä—Ç–∏—Ä—É?'\n\n"
            f"–ö–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç: {user_message}. –û—Ç–≤–µ—Ç—å –µ–º—É."
        )

        response = generate_response(user_id, prompt)

    else:
        time.sleep(8)
        response = generate_response(user_id, user_message)
        entity = await client.get_entity(user_id)

        ##TO DO name change to id
        if response.count("üü£") == 1:
            for apartment in apartments:
                response_cleaned = response.lower()
                if fuzz.partial_ratio(apartment["name"].lower(), response_cleaned) > 80:
                    await send_apartment_photo(user_id, apartment["id"])
                    break

        if "—É—Ç–æ—á–Ω—é —É —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞" in response:
            await client.send_message(
                "me",
                f"( –∫–ª–∏–µ–Ω—Ç @{entity.username} –∂–¥–µ—Ç –æ—Ç–≤–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞)",
            )
        if "–≤–∞–º —É–¥–æ–±–Ω–æ –±—É–¥–µ—Ç?" in response or "–≤–∞–º —É–¥–æ–±–Ω–æ –±—É–¥–µ—Ç?" in response:
            await client.send_message(
                "me", f"( –∫–ª–∏–µ–Ω—Ç @{entity.username} —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä"
            )

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
    await event.reply(response)
    print(f"–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: {response}")


async def main():
    await client.start()
    print("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!")

    me = await client.get_me()
    print(f"–Ø –≤–æ—à–µ–ª –∫–∞–∫: {me.first_name} ({me.username})")

    await client.run_until_disconnected()


# –ó–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç
with client:
    client.loop.run_until_complete(main())
